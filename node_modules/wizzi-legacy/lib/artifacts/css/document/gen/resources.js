var path = require('path');
var file = require('wizzi-core').file;

var md = module.exports = {};

var resources = {};
function r(name, fileName) {
    name = name.toLowerCase();
    resources[name] = path.join(__dirname, 'resources', 'lib', 'css', fileName)
}

r('angular-table', 'ng-table.css');
r('bootstrap', 'bootstrap.wizzi.css');
r('bootstrap-slider', 'bootstrap-slider/bootstrap-slider.css');
r('codemirror-js', 'codemirror/lib/codemirror.css');
r('font-awesome', 'font-awesome-4.4.0/css/font-awesome.wizzi.css');
r('form-validation', 'formValidation.min.css');
r('humane', 'humane/themes/jackedup.css');
r('iconfont-awesome', 'fontawesome-iconpicker/dist/css/fontawesome-iconpicker.css');
r('iphonecheck', 'iphonecheck/iphone-style-checkboxes.wizzi.css');
r('prettify', 'google-code-prettify/src/form.select2.prettify.css');
r('select2', 'select2/dist/css/select2.css')
r('select2-bootstrap', 'select2-bootstrap-theme/dist/select2-bootstrap.css');
r('sh', 'syntaxhighlighter_3.0.83/styles/shCore.css');
r('sh-core-default', 'syntaxhighlighter_3.0.83/styles/shCoreDefault.css');
r('sh-theme-default', 'syntaxhighlighter_3.0.83/styles/shThemeDefault.css');
r('spectrum', 'spectrum.css');
r('spin', 'spin.css');
r('typeahead', 'typeahead/typeahead.css')

md.cssRequested = {}
md.isEmitted = {}

md.clearCssDependencies = function()
{
    md.cssRequested = {}
    md.isEmitted = {}
}
md.addCssDependency = function (deps) {
    var depsArray = deps.split(',')
    depsArray.forEach(function (dep) {
        md.cssRequested[dep] = true;
    });
}
md.emitCssDependencies = function (ctx) {
    for (var k in md.cssRequested) {
        if (md.cssRequested[k] === true) md._emitCssDependency(k, ctx);
    }
}
md._emitCssDependency = function (dep, ctx) {
    var dep = dep.trim().toLowerCase();
    if (md.isEmitted[dep]) return;
    md.isEmitted[dep] = true;
    var goon = md.checkRequirements(dep, ctx);
    if (!goon) return;
    var fileName = resources[dep];
    if (!fileName) {
        throw new Error("Css.module.generation. Dependency " + dep + ' not found.');
    }
    if (file.exists(fileName)) {
        var content = file.read(fileName);
        ctx.w(content);
        // console.log('_emitCssDependency', fileName);
    } else {
        throw new Error("Css.module.generation. File for dependency " + dep + ' not found. Filename: ' + fileName);
    }
    md.checkTail(dep, ctx);
}
md.checkRequirements = function (dep, ctx) {
    if (dep === 'form-validation') {
        md._emitCssDependency('font-awesome', ctx)
    }
    else if (dep === 'form-validation-bootstrap')
    {
        md._emitCssDependency('bootstrap', ctx)
        md._emitCssDependency('form-validation', ctx)
        return false;
    }
    else if (['bootstrap-switch', 'bootstrap-slider'].indexOf(dep) >= 0) {
        md._emitCssDependency('bootstrap', ctx)
    }
    else if (['sh-js', 'sh-xml'].indexOf(dep) >= 0) {
        md._emitCssDependency('sh', ctx)
        md._emitCssDependency('sh-core-default', ctx)
        md._emitCssDependency('sh-theme-default', ctx)
        return false;
    }
    return true;
}
md.checkTail = function (dep, ctx) {
    if (dep === 'select2') {
        md._emitCssDependency('select2-bootstrap', ctx)
    }
}




