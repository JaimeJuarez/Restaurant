// generator: wizzi-lab-artifatcs/lib/js/module/gen/main.js, utc time: Thu, 22 Oct 2015 19:39:40 GMT
var path = require('path');
var GenWriter = require('wizzi-core').GenWriter;
var StringWriter = require('wizzi-core').stringwriter;
var log = require('wizzi-core').log(module);
var options = require('wizzi-core').options;
var file = require('wizzi-core').file;
var ittf = require('wizzi-ittf');
var legacy = require('wizzi-legacy');
var md = module.exports = {};
md.name = 'wizzi-factory';
md.ProductionContext = require('./lib/production/context');
md.ProductionManager = require('./lib/production/manager');
md.ProductionService = require('./lib/production/service');
md.options = require('./lib/production/options');
/**
     local wizzi models
*/
// async load a WizziModel of type 'wfjob' from an IttfDocument

md.wfjob = function(ittfDocumentPath, context, callback) {
    var loader = md.getWizziModelLoader('wfjob');
    loader.load(ittfDocumentPath, context, function(err, wizziModel) {
        if (err) {
            return callback(err, null);
        }
        callback(null, wizziModel);
    });
};
/**
     expose wizzi models, transformations and artifacts to the wizzi factory
*/

md.ittf = function(filepath, context, callback) {
    ittf.loadModel(filepath, context, function(err, ittfModel) {
        var ittfmodel = ittfModel.nodes[0];
        // log 'md.ittf.filepath', filepath, ittfmodel
        callback(null, ittfmodel);
    });
};

md.ittfFromString = function(content, context, callback) {
    ittf.loadModelFromString(content, context, function(err, ittfModel) {
        var ittfmodel = ittfModel.nodes[0];
        // log 'md.ittf.filepath', filepath, ittfmodel
        callback(null, ittfmodel);
    });
};
var wizziModelLoaders = {};
var wizziSchemaObjects = {};
// retrieve a WizziModelLoader by its wizzischema name

md.getWizziModelLoader = function(schemaName) {
    if (wizziModelLoaders[schemaName]) {
        return wizziModelLoaders[schemaName];
    }
    else {
        var modulePath = path.resolve(__dirname, './lib/wizzi/models/' + schemaName + '-loader.g.js');
        if (file.exists(modulePath)) {
            var ret = require('./lib/wizzi/models/' + schemaName + '-loader.g');
            wizziModelLoaders[schemaName] = ret;
            return ret;
        }
        else {
            log.warn('Wizzi model loader module path do not exists: ' + modulePath);
            return null;
        }
    }
};
// retrieve a WizziSchemaObject object from its JSON representation

md.getWizziSchemaObject = function(schemaName) {
    if (wizziSchemaObjects[schemaName]) {
        return wizziSchemaObjects[schemaName];
    }
    else {
        var modulePath = path.resolve(__dirname, './lib/wizzi/models/' + schemaName + '-schema.g.json');
        if (file.exists(modulePath)) {
            var ret = require('./lib/wizzi/models/' + schemaName + '-schema.g.json');
            wizziSchemaObjects[schemaName] = ret;
            return ret;
        }
        else {
            log.warn('Wizzi schema object module path do not exists: ' + modulePath);
            return null;
        }
    }
};
var modelTransformers = {};
// async execute a model transformation

md.doModelTransformation = function(model, transformationName, context, callback) {
    var transformer = md.getModelTransformer(transformationName);
    if (transformer == null) {
        throw new Error('doModelTransformation. Cannot find transformer ' + transformationName);
    }
    else {
        new transformer.trans(model, context, callback);
    }
};
// retrieve a ModelTransformer by its name

md.getModelTransformer = function(transformerName) {
    if (modelTransformers[transformerName]) {
        return modelTransformers[transformerName];
    }
    else {
        var modulePath = path.resolve(__dirname, './lib/artifacts/' + transformerName + '/trans/main.js');
        if (file.exists(modulePath)) {
            var ret = require('./lib/artifacts/' + transformerName + '/trans/main');
            modelTransformers[transformerName] = ret;
            return ret;
        }
        else {
            log.warn('Transformer module path do not exists: ' + modulePath);
            return null;
        }
    }
};
var artifactGenerators = {};
// async execute an artifact generation
// the context parameter may contain a __data property that is
// set on the genWriter options.data property

md.doArtifactGeneration = function doArtifactGeneration(wizziModelInstance, sourceFilepathInfo, generationPath, context, callback) {
    var genWriter = new GenWriter({ options: options(null, { data: context.__data }) });
    var generator = md.getArtifactGenerator(generationPath);
    try {
        new generator.gen(wizziModelInstance, genWriter);
    } catch (ex) {
        ex.message = 'doArtifactGeneration exception. In file ' + sourceFilepathInfo + '.\n' + ex.message;
        throw ex;
    }
    var sw = new StringWriter();
    genWriter.toStream(sw);
    callback(null, sw.toString());
};
// retrieve an ArtifactGenerator by its name

md.getArtifactGenerator = function(generationPath) {
    var generator = artifactGenerators[generationPath];
    if (!generator) {
        var modulePath = path.resolve(__dirname, './lib/artifacts/' + generationPath + '/gen/main.js');
        if (file.exists(modulePath)) {
            generator = artifactGenerators[generationPath] = require('./lib/artifacts/' + generationPath + '/gen/main');
        }
        else {
            log.warn('module path do not exists: ' + modulePath);
        }
    }
    return generator;
};
/**
     legacy wizzi models
*/

md.js = function(ittfDocumentPath, context, callback) {
    legacy.js(ittfDocumentPath, context, function(err, wizziModel) {
        if (err) {
            return callback(err, null);
        }
        callback(null, wizziModel);
    });
};

md.css = function(ittfDocumentPath, context, callback) {
    legacy.css(ittfDocumentPath, context, function(err, wizziModel) {
        if (err) {
            return callback(err, null);
        }
        callback(null, wizziModel);
    });
};

md.html = function(ittfDocumentPath, context, callback) {
    legacy.html(ittfDocumentPath, context, function(err, wizziModel) {
        if (err) {
            return callback(err, null);
        }
        callback(null, wizziModel);
    });
};
/**
     legacy artifacts generators
*/

md.getLegacyArtifactGenerator = function(artifactName) {
    return legacy.getArtifactGenerator(artifactName);
};
