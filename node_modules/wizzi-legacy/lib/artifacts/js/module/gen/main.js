var statement = require('./statement');
var clazz = require('./clazz');
var resources = require('./resources');

var md = module.exports = {};
var myname = 'js.module.main';

md.gen = function (model, ctx) {
    if (!model.includes) console.log(myname + '.gen.model', model);
    md.gen.prototype.js_includeDependencies(model, ctx);
    ctx.w('// generator: wizzi-lab-artifatcs/lib/js/module/gen/main.js, utc time: ' + new Date().toUTCString());
    if (model.use_strict) ctx.w("'use strict';");
    if (model.kind === 'nodejs.module.var') {
        ctx.__member_kind = 'var';
        this.nodejs_var(model, ctx);
    } else if (model.kind === 'jsfile' || model.kind === 'jstest') {
        this.js_file(model, ctx);
    } else throw ctx.error(myname + '.ctor. Unknown module kind: ' + model.kind);
}

md.gen.prototype.nodejs_var = function (model, ctx) {
    ctx.a('md_var', model.exportName);
    ctx.w("var util = require('util');");
    ctx.w("");
    ctx.w("var {md_var} = module.exports = {};");
    ctx.w("");
    model.statements.forEach(function (item) {
        if (item.WmtEntity === 'class') {
            item.exportKind = model.exportKind;
            item.exportName = model.exportName;
            new clazz.gen(item, ctx);
            ctx.w("");
        } else {
            statement.gen(item, ctx);
        }
    });
}

md.gen.prototype.js_file = function (model, ctx) {
    model.statements.forEach(function (item) {
        if (item.WmtEntity === 'class') {
            item.exportKind = model.exportKind;
            item.exportName = model.exportName;
            new clazz.gen(item, ctx);
            ctx.w("");
        } else {
            statement.gen(item, ctx);
        }
    });
}

md.gen.prototype.js_includeDependencies = function (model, ctx) {
    resources.clearJsDependencies();
    model.includes.forEach(function (item) {
        resources.addJsDependency(item.WmtName);
    });
    resources.emitJsDependencies(ctx);
}