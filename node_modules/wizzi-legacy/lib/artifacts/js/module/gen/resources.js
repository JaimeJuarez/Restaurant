var path = require('path');
var file = require('wizzi-core').file;

var md = module.exports = {};

var resources = {};
function r(name, fileName) {
    name = name.toLowerCase();
    resources[name] = path.join(__dirname, 'resources', 'lib', 'js', fileName)
}

r('ace', 'ace-builds/src-noconflict/ace.js');
r('ace-js', 'ace-builds/src-noconflict/mode-javascript.js');
r('ace-monokay', 'ace-builds/src-noconflict/theme-monokai.js');
r('angular', 'angular.js')
r('angular-animate', 'angular-animate.js')
r('angular-local-storage', 'angular-local-storage.js')
r('angular-resource', 'angular-resource.js')
r('angular-route', 'angular-route.js')
r('angular-scroll', 'angular-scroll.js')
r('angular-strap', 'angular-strap.js')
r('angular-strap-tpl', 'angular-strap.tpl.js')
r('angular-table', 'ng-table.js')
r('angular-translate', 'angular-translate.js')
r('angular-translate-loader-partial', 'angular-translate-loader-partial.js')
r('angular-ui-router','angular-ui-router/angular-ui-router.js');
r('textarea-autosize', 'autosize/dist/autosize.js');
r('base64', 'base64.js')
r('bootbox', 'bootbox.js')
r('bootstrap', 'bootstrap.js')
r('bootstrap-switch', 'bootstrap-switch.js')
r('bootstrap-slider', 'bootstrap-slider/bootstrap-slider.js');
r('codemirror', 'codemirror/lib/codemirror.js')
r('codemirror-js', 'codemirror/mode/javascript/javascript.js')
r('form-validation', 'formvalidation.min.js')
r('form-validation-bootstrap', 'formvalidation.bootstrap.min.js')
r('fonticon', 'fontIconPicker/jquery.fonticonpicker.js')
r('geocomplete', 'geocomplete/jquery.geocomplete.js');
r('humane', 'humane/humane.js');
r('handlebars', 'handlebars.js');
r('iconfont-awesome', 'fontawesome-iconpicker/dist/js/fontawesome-iconpicker.js')
r('iphonecheck', 'iphonecheck/iphone-style-checkboxes.js');
r('jquery', 'jquery.js');
r('jquery-mask', 'jquery.mask/jquery.mask.js');
r('prettify', 'google-code-prettify/src/prettify.js');
r('progress', 'progress/progress.js')
r('sh', 'syntaxhighlighter_3.0.83/scripts/shCore.js')
r('sh-autoloader', 'syntaxhighlighter_3.0.83/scripts/shAutoloader.js')
r('sh-js', 'syntaxhighlighter_3.0.83/scripts/shBrushJScript.js')
r('sh-plain', 'syntaxhighlighter_3.0.83/scripts/shBrushPlain.js')
r('sh-xml', 'syntaxhighlighter_3.0.83/scripts/shBrushXml.js')
r('select2', 'select2/dist/js/select2.full.js')
r('spectrum', 'spectrum/spectrum.js')
r('spinner', 'spin.js')
r('string', 'string.js')
r('typeahead', 'typeahead.bundle.js');
r('underscore', 'underscore.js')

md.jsRequested = {}
md.isEmitted = {}

md.clearJsDependencies = function()
{
    md.jsRequested = {}
    md.isEmitted = {}
}
md.addJsDependency = function (deps) {
    var depsArray = deps.split(',')
    depsArray.forEach(function (dep) {
        md.jsRequested[dep] = true;
    });
}
md.emitJsDependencies = function (ctx) {
    for (var k in md.jsRequested) {
        if (md.jsRequested[k] === true) md._emitJsDependency(k, ctx);
    }
}
md._emitJsDependency = function (dep, ctx) {
    var dep = dep.trim().toLowerCase();;
    if (md.isEmitted[dep]) return;
    md.isEmitted[dep] = true;
    md.checkRequirements(dep, ctx);
    var fileName = resources[dep];
    if (!fileName) {
        throw new Error("Js.module.generation. Dependency " + dep + ' not found.');
    }
    if (file.exists(fileName)) {
        var content = file.read(fileName);
        ctx.w(content);
    } else {
        throw new Error("Js.module.generation. File for dependency " + dep + ' not found. Filename: ' + fileName);
    }
    md.checkTail(dep, ctx);
}
md.checkRequirements = function (dep, ctx) {
    if (dep === 'ace-js') {
        md._emitJsDependency('ace', ctx)
        md._emitJsDependency('ace-monokay', ctx)
    } else if (dep === 'angular-resource') {
        md._emitJsDependency('angular', ctx)
    } else if (dep === 'bootbox') {
        md._emitJsDependency('bootstrap', ctx)
    } else if (dep === 'bootstrap') {
        md._emitJsDependency('jquery', ctx)
    } else if (dep === 'angular-strap') {
        md._emitJsDependency('angular-animate', ctx)
    } else if (['bootstrap-switch', 'bootstrap-slider'].indexOf(dep) >= 0) {
        md._emitJsDependency('bootstrap', ctx)
    } else if (dep === 'codemirror-js') {
        md._emitJsDependency('codemirror', ctx)
    } else if (dep === 'form-validation-bootstrap') {
        md._emitJsDependency('bootstrap', ctx)
        md._emitJsDependency('form-validation', ctx)
    } else if (dep === 'select2-bootstrap') {
        md._emitJsDependency('bootstrap', ctx)
        md._emitJsDependency('select2', ctx)
    } else if (dep === 'iphonecheck') {
        md._emitJsDependency('jquery', ctx)
    } else if (dep === 'jquery-mask') {
        md._emitJsDependency('jquery', ctx)
    } else if (['sh-js', 'sh-xml'].indexOf(dep) >= 0) {
        md._emitJsDependency('sh', ctx)
        md._emitJsDependency('sh-autoloader', ctx)
        md._emitJsDependency('sh-plain', ctx)
        md._emitJsDependency('sh-xml', ctx)
    } else if (dep === 'typeahead') {
        md._emitJsDependency('bootstrap', ctx)
    }
}
md.checkTail = function (dep, ctx) {
    if (dep === 'angular-translate') {
        md._emitJsDependency('angular-translate-loader-partial', ctx)
    } else if (dep === 'angular-strap') {
        md._emitJsDependency('angular-strap-tpl', ctx)
    }
}


